<div class="admin-container">
  <div class="admin-header">
    <h1>Admin Dashboard - Product Management</h1>
    <button class="btn btn-primary" (click)="openAddForm()" [disabled]="isLoading">
      <span>+</span> Add New Product
    </button>
  </div>

  <!-- Messages -->
  <div class="messages">
    @if (errorMessage) {
      <div class="alert alert-error">
        {{ errorMessage }}
        <button class="close-btn" (click)="errorMessage = ''">&times;</button>
      </div>
    }
    @if (successMessage) {
      <div class="alert alert-success">
        {{ successMessage }}
        <button class="close-btn" (click)="successMessage = ''">&times;</button>
      </div>
    }
  </div>

  <!-- Search Bar and Page Size -->
  <div class="search-bar">
    <input
      type="text"
      [value]="searchTerm"
      (input)="onSearchInput($event)"
      placeholder="Search products by name, description, or category..."
      class="search-input"
      />
    <div class="page-size-selector">
      <label for="pageSize">Items per page:</label>
      <select
        id="pageSize"
        [(ngModel)]="pageSize"
        (change)="onPageSizeChange()"
        class="page-size-select"
        >
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
    </div>
  </div>

    <!-- Loading Indicator -->
    @if (isLoading) {
      <div class="loading">
        <p>Loading products...</p>
      </div>
    }

    <!-- Products Table -->
    @if (!isLoading) {
      <div class="products-table-container">
        <table class="products-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Category</th>
              <th>Price</th>
              <th>Discount</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Prescription</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (product of filteredProducts; track product) {
              <tr class="product-row">
                <td>
                  <img
                    [src]="product.imageUrl || 'https://via.placeholder.com/50'"
                    [alt]="product.name"
                    class="product-image"
                    />
                  </td>
                  <td class="product-name">{{ product.name }}</td>
                  <td>{{ product.categoryName || 'N/A' }}</td>
                  <td class="price">${{ product.price }}</td>
                  <td class="discount">
                    @if (product.discountPrice) {
                      <span>${{ product.discountPrice }}</span>
                    }
                    @if (!product.discountPrice) {
                      <span>-</span>
                    }
                  </td>
                  <td>{{ product.quantity || 0 }}</td>
                  <td>
                    <span
                      [class]="product.isActive ? 'badge badge-success' : 'badge badge-danger'"
                      >
                      {{ product.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td>
                    <span
                      [class]="product.isPrescriptionRequired ? 'badge badge-warning' : 'badge badge-info'"
                      >
                      {{ product.isPrescriptionRequired ? 'Required' : 'Not Required' }}
                    </span>
                  </td>
                  <td class="actions">
                    <button
                      class="btn btn-sm btn-edit"
                      (click)="openEditForm(product)"
                      [disabled]="isLoading"
                      >
                      Edit
                    </button>
                    <button
                      class="btn btn-sm btn-toggle"
                      (click)="toggleProductStatus(product)"
                      [disabled]="isLoading"
                      >
                      {{ product.isActive ? 'Deactivate' : 'Activate' }}
                    </button>
                    <button
                      class="btn btn-sm btn-delete"
                      (click)="deleteProduct(product.id)"
                      [disabled]="isLoading"
                      >
                      Delete
                    </button>
                  </td>
                </tr>
              }
              @if (filteredProducts.length === 0) {
                <tr>
                  <td colspan="9" class="no-products">
                    No products found. {{ searchTerm ? 'Try a different search term.' : 'Click "Add New Product" to get started.' }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        @if (totalPages > 0) {
          <div class="pagination-container">
            <div class="pagination-info">
              Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalCount) }} of {{ totalCount }} products
            </div>
            <div class="pagination-controls">
              <button
                class="btn btn-pagination"
                (click)="previousPage()"
                [disabled]="!hasPrevious || isLoading"
                >
                Previous
              </button>
              
              @for (pageNum of getPageNumbers(); track pageNum) {
                <button
                  class="btn btn-pagination"
                  [class.active]="pageNum === currentPage"
                  (click)="goToPage(pageNum)"
                  [disabled]="isLoading"
                  >
                  {{ pageNum }}
                </button>
              }
              
              <button
                class="btn btn-pagination"
                (click)="nextPage()"
                [disabled]="!hasNext || isLoading"
                >
                Next
              </button>
            </div>
          </div>
        }
      }

      <!-- Product Form Modal -->
      @if (showForm) {
        <div class="modal-overlay" (click)="closeForm()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2>{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h2>
              <button class="close-btn" (click)="closeForm()">&times;</button>
            </div>
            <form (ngSubmit)="onSubmit()" class="product-form">
              <div class="form-group">
                <label for="name">Product Name *</label>
                <input
                  type="text"
                  id="name"
                  [(ngModel)]="productForm.name"
                  name="name"
                  required
                  class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label for="description">Description *</label>
                  <textarea
                    id="description"
                    [(ngModel)]="productForm.description"
                    name="description"
                    rows="4"
                    required
                    class="form-control"
                  ></textarea>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="price">Price *</label>
                    <input
                      type="number"
                      id="price"
                      [(ngModel)]="productForm.price"
                      name="price"
                      min="0"
                      step="0.01"
                      required
                      class="form-control"
                      />
                    </div>
                    <div class="form-group">
                      <label for="discountPrice">Discount Price</label>
                      <input
                        type="number"
                        id="discountPrice"
                        [(ngModel)]="productForm.discountPrice"
                        name="discountPrice"
                        min="0"
                        step="0.01"
                        class="form-control"
                        />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="categoryId">Category *</label>
                        <select
                          id="categoryId"
                          [(ngModel)]="productForm.categoryId"
                          name="categoryId"
                          required
                          class="form-control"
                          >
                          <option value="0">Select a category</option>
                          @for (category of categories; track category) {
                            <option [value]="category.id">
                              {{ category.name }}
                            </option>
                          }
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="stock">Stock Quantity</label>
                        <input
                          type="number"
                          id="stock"
                          [(ngModel)]="productForm.stock"
                          name="stock"
                          min="0"
                          class="form-control"
                          />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group checkbox-group">
                          <label>
                            <input
                              type="checkbox"
                              [(ngModel)]="productForm.isPrescriptionRequired"
                              name="isPrescriptionRequired"
                              />
                              Prescription Required
                            </label>
                          </div>
                          <div class="form-group checkbox-group">
                            <label>
                              <input
                                type="checkbox"
                                [(ngModel)]="productForm.isActive"
                                name="isActive"
                                />
                                Active Product
                              </label>
                            </div>
                          </div>
                          <div class="form-group">
                            <label for="image">Product Image</label>
                            <input
                              type="file"
                              id="image"
                              (change)="onImageSelected($event)"
                              accept="image/*"
                              class="form-control"
                              />
                              @if (imagePreview) {
                                <div class="image-preview">
                                  <img [src]="imagePreview" alt="Preview" />
                                </div>
                              }
                            </div>
                            <div class="form-actions">
                              <button
                                type="button"
                                class="btn btn-secondary"
                                (click)="closeForm()"
                                [disabled]="isLoading"
                                >
                                Cancel
                              </button>
                              <button
                                type="submit"
                                class="btn btn-primary"
                                [disabled]="isLoading"
                                >
                                {{ isLoading ? 'Saving...' : (isEditMode ? 'Update Product' : 'Create Product') }}
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    }
                  </div>
